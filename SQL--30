-- Create database tables with enhanced schema
CREATE TABLE school_info (
    id SERIAL PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    keywords TEXT[],
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE school_hours (
    id SERIAL PRIMARY KEY,
    day_of_week VARCHAR(10) NOT NULL,
    opening_time TIME NOT NULL,
    closing_time TIME NOT NULL,
    notes TEXT
);

CREATE TABLE facilities (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    location VARCHAR(50),
    availability TEXT,
    keywords TEXT[]
);

CREATE TABLE faqs (
    id SERIAL PRIMARY KEY,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    category VARCHAR(50) NOT NULL,
    keywords TEXT[],
    popularity INTEGER DEFAULT 0
);

-- Insert sample data with complete field information
INSERT INTO school_info (category, question, answer, keywords) VALUES
('General', 'What are the school hours?', 'The school operates from 8:00 AM to 3:30 PM Monday to Friday, with some variations for extracurricular activities.', ARRAY['hours', 'timing', 'schedule']),
('General', 'What is the school''s mission statement?', 'K.T.M.C. is committed to providing quality education that nurtures students'' intellectual, physical, social, and moral development to become responsible global citizens.', ARRAY['mission', 'vision', 'philosophy']),
('Admissions', 'What is the admission process?', 'Admissions typically involve submission of application forms, academic records, an interview, and possibly an entrance assessment.', ARRAY['apply', 'application', 'enrollment']),
('Academics', 'What curriculum does the school follow?', 'We follow the Hong Kong curriculum with enhancements to provide a well-rounded education.', ARRAY['syllabus', 'program', 'studies']),
('Admissions', 'What are the age requirements for Year 1 admission?', 'Children must be 5 years old by August 31st of the admission year to be eligible for Year 1.', ARRAY['age', 'eligibility', 'year 1']),
('Admissions', 'Does the school offer scholarships?', 'Yes, we offer academic, sports, and arts scholarships for outstanding students. Applications are due by March 1st each year.', ARRAY['financial aid', 'scholarship', 'bursary']),
('Admissions', 'Are there any entrance exams for secondary school admission?', 'Yes, secondary school applicants must complete exams in English, Chinese, and Mathematics, plus an interview.', ARRAY['entrance test', 'assessment', 'secondary']),
('Academics', 'What is the student-teacher ratio?', 'Our average class size is 25 students with a student-teacher ratio of 15:1 across the school.', ARRAY['class size', 'ratio', 'faculty']),
('Academics', 'Does the school offer IB or A-Level programs?', 'We offer both Hong Kong Diploma of Secondary Education (HKDSE) and A-Level programs for senior students.', ARRAY['curriculum', 'qualifications', 'exams']),
('Facilities', 'Is there a maker space or STEM lab?', 'Yes, our STEM Innovation Center includes a maker space with 3D printers, robotics equipment, and coding stations.', ARRAY['technology', 'lab', 'innovation']),
('Facilities', 'What sports facilities are available?', 'We have a swimming pool, gymnasium, basketball courts, football pitch, and indoor sports hall.', ARRAY['sports', 'athletics', 'physical education']),
('Campus Life', 'What extracurricular activities are offered?', 'We offer over 50 activities including sports teams, music ensembles, debate club, robotics, and community service programs.', ARRAY['ECA', 'activities', 'clubs']),
('Campus Life', 'Is there a school uniform?', 'Yes, all students must wear the official school uniform which can be purchased at our designated supplier.', ARRAY['dress code', 'attire', 'clothing']),
('Transportation', 'What school bus routes are available?', 'We have 12 bus routes covering Hong Kong Island, Kowloon, and the New Territories. Route maps are available at the administration office.', ARRAY['bus', 'transport', 'commute']),
('Transportation', 'Is there MTR shuttle service from the nearest station?', 'Yes, we provide a free shuttle bus from Kowloon Tong MTR station every 15 minutes during peak hours.', ARRAY['MTR', 'shuttle', 'public transport']),
('Events', 'When is the next open day?', 'Our next open day will be on November 15th, 2023 from 9:00 AM to 3:00 PM. Registration is available on our website.', ARRAY['open house', 'visit', 'tour']),
('Events', 'How often are parent-teacher meetings held?', 'Formal PTMs are held twice per year, but parents may schedule individual meetings with teachers as needed.', ARRAY['meeting', 'parents', 'communication']),
('Health & Safety', 'What medical facilities are available on campus?', 'We have a fully staffed medical room with a trained nurse available during all school hours.', ARRAY['health', 'first aid', 'medical']),
('Health & Safety', 'What is the school''s bullying policy?', 'We have a zero-tolerance policy with clear reporting procedures and support systems for all students.', ARRAY['anti-bullying', 'safety', 'welfare']),
('Technology', 'Do students need to bring their own devices?', 'Yes, we operate a BYOD (Bring Your Own Device) program for students in Year 4 and above.', ARRAY['laptop', 'tablet', 'technology']),
('Technology', 'Is coding part of the curriculum?', 'Yes, computational thinking and coding are taught from Year 3 through our integrated STEM program.', ARRAY['programming', 'computer science', 'digital literacy']),
('Academic Support', 'Is there tutoring available for struggling students?', 'Yes, we offer peer tutoring and teacher-led support sessions after school three days a week.', ARRAY['help', 'remedial', 'support']),
('Academic Support', 'How does the school support gifted students?', 'We offer enrichment programs, advanced courses, and mentorship opportunities for high-ability learners.', ARRAY['gifted', 'talented', 'extension']),
('Food Services', 'What meal options are available at the canteen?', 'Our canteen offers healthy hot meals, sandwiches, and vegetarian options daily. Menus are approved by a nutritionist.', ARRAY['lunch', 'food', 'canteen']),
('Food Services', 'Can students bring their own food?', 'Yes, students may bring home-packed lunches. We are a nut-aware school.', ARRAY['allergies', 'packed lunch', 'diet']),
('International Students', 'Does the school offer ESL support?', 'Yes, we have a comprehensive English as a Second Language program with multiple proficiency levels.', ARRAY['ESL', 'English', 'language support']),
('International Students', 'What visa support is available for overseas students?', 'We provide documentation and guidance for student visa applications through our admissions office.', ARRAY['visa', 'immigration', 'international']),
('Special Needs', 'What learning support services are available?', 'We have a dedicated SEN department offering individualized education plans and specialist support.', ARRAY['SEN', 'special needs', 'inclusion']),
('Special Needs', 'Is the campus wheelchair accessible?', 'Yes, our campus has elevators, ramps, and accessible facilities throughout all buildings.', ARRAY['disability', 'accessibility', 'mobility']),
('Graduation', 'What university placement support is provided?', 'Our career counselors provide personalized guidance including application support and interview preparation.', ARRAY['university', 'higher education', 'careers']),
('Graduation', 'What percentage of graduates attend university?', 'Over 95% of our graduates secure places at local and international universities each year.', ARRAY['results', 'placement', 'statistics']);

INSERT INTO school_hours (day_of_week, opening_time, closing_time, notes) VALUES
('Monday', '08:00:00', '15:30:00', 'Regular hours'),
('Tuesday', '08:00:00', '15:30:00', 'Regular hours'),
('Wednesday', '08:00:00', '15:30:00', 'Regular hours'),
('Thursday', '08:00:00', '15:30:00', 'Regular hours'),
('Friday', '08:00:00', '15:30:00', 'Regular hours'),
('Saturday', '09:00:00', '12:00:00', 'Limited facilities open'),
('Sunday', '00:00:00', '00:00:00', 'Campus closed');

INSERT INTO facilities (name, description, location, availability, keywords) VALUES
('Swimming Pool', 'Olympic-sized pool with 6 lanes', 'East Wing', 'Mon-Fri 3:30-6:30 PM, Sat 9 AM-12 PM', ARRAY['aquatics', 'swim', 'pool']),
('Library', 'Over 20,000 books in Chinese and English', 'Main Building 2F', 'Mon-Fri 8 AM-5 PM', ARRAY['books', 'reading', 'research']),
('Science Lab', 'Fully equipped laboratory for physics, chemistry, and biology', 'North Wing 3F', 'During school hours', ARRAY['experiments', 'science', 'lab']),
('Auditorium', '500-seat venue with full AV capabilities', 'Central Block', 'By booking only', ARRAY['performances', 'events', 'assembly']),
('Sports Field', 'Artificial turf football pitch with running track', 'West Campus', 'Mon-Sat 7 AM-7 PM', ARRAY['athletics', 'soccer', 'track']),
('Music Rooms', 'Soundproof practice rooms with instruments', 'Arts Wing', 'During school hours and by appointment', ARRAY['music', 'practice', 'band']),
('Cafeteria', '300-seat dining area with healthy meal options', 'Ground Floor', 'Mon-Fri 7:30 AM-4:30 PM', ARRAY['dining', 'lunch', 'canteen']);

INSERT INTO faqs (question, answer, category, keywords, popularity) VALUES
('What are the school fees?', 'Annual tuition ranges from HKD 50,000 to HKD 80,000 depending on grade level.', 'Finance', ARRAY['fees', 'tuition', 'cost'], 45),
('Is there a school bus service?', 'Yes, we offer bus routes covering most areas of Hong Kong Island and Kowloon.', 'Transportation', ARRAY['bus', 'transport', 'routes'], 32),
('What languages are taught?', 'Mandarin and English are core languages, with options for French and Spanish in senior years.', 'Academics', ARRAY['languages', 'bilingual', 'foreign'], 28),
('How do I apply for financial aid?', 'Financial aid applications are available through the bursar''s office and due by April 30th each year.', 'Finance', ARRAY['financial aid', 'scholarship', 'assistance'], 19),
('What is the homework policy?', 'Homework is assigned regularly with guidelines of 30-60 minutes per subject depending on grade level.', 'Academics', ARRAY['homework', 'assignments', 'study'], 22),
('Are there boarding options?', 'Yes, we offer boarding facilities for students in Year 7 and above with separate houses for boys and girls.', 'Campus Life', ARRAY['boarding', 'dormitory', 'residential'], 15),
('What security measures are in place?', 'We have 24/7 security personnel, CCTV monitoring, and controlled access to all campus buildings.', 'Health & Safety', ARRAY['security', 'safety', 'protection'], 27),
('How does the school handle typhoon days?', 'We follow EDB announcements. If typhoon signal 8 or black rainstorm is hoisted, school will be closed.', 'General', ARRAY['weather', 'typhoon', 'closures'], 31),
('What sports teams can students join?', 'We field competitive teams in basketball, football, swimming, volleyball, and track & field.', 'Campus Life', ARRAY['sports', 'teams', 'athletics'], 18),
('Is there a parent volunteer program?', 'Yes, we welcome parent volunteers for events, reading programs, and campus activities.', 'Community', ARRAY['volunteer', 'parents', 'involvement'], 12);

-- Sample queries for the chatbot
-- 1. Select all questions about transportation
SELECT question, answer FROM school_info 
WHERE category = 'Transportation' 
OR EXISTS (SELECT 1 FROM unnest(keywords) AS k WHERE k ILIKE '%transport%');

-- 2. Count how many Q&As are in each category
SELECT category, COUNT(*) as question_count 
FROM school_info 
GROUP BY category 
ORDER BY question_count DESC;

-- 3. Retrieve all entries containing the keyword "open day"
SELECT question, answer, category 
FROM school_info 
WHERE EXISTS (SELECT 1 FROM unnest(keywords) AS k WHERE k ILIKE '%open day%')
OR question ILIKE '%open day%' 
OR answer ILIKE '%open day%';

-- 4. List all unique categories
SELECT DISTINCT category FROM school_info 
UNION 
SELECT DISTINCT category FROM faqs 
ORDER BY category;

-- 5. Search for answers containing the word "canteen"
SELECT question, answer, category 
FROM school_info 
WHERE answer ILIKE '%canteen%'
UNION
SELECT question, answer, category 
FROM faqs 
WHERE answer ILIKE '%canteen%';

-- 6. Get popular FAQs ordered by popularity
SELECT question, answer, popularity 
FROM faqs 
ORDER BY popularity DESC 
LIMIT 5;

-- 7. Find facilities with specific features
SELECT name, description, availability 
FROM facilities 
WHERE EXISTS (SELECT 1 FROM unnest(keywords) AS k WHERE k ILIKE '%sport%');

-- 8. Update a FAQ's popularity
UPDATE faqs SET popularity = popularity + 1 
WHERE id = 3 
RETURNING question, popularity;

-- 9. Full-text search across all tables (PostgreSQL specific)
SELECT question, answer, 'school_info' as source 
FROM school_info 
WHERE to_tsvector('english', question || ' ' || answer) @@ to_tsquery('english', 'scholarship & application')
UNION
SELECT question, answer, 'faqs' as source 
FROM faqs 
WHERE to_tsvector('english', question || ' ' || answer) @@ to_tsquery('english', 'scholarship & application');

-- 10. Get school hours with extended notes
SELECT day_of_week, 
       opening_time || ' - ' || closing_time AS hours,
       notes
FROM school_hours
ORDER BY 
  CASE day_of_week
    WHEN 'Monday' THEN 1
    WHEN 'Tuesday' THEN 2
    WHEN 'Wednesday' THEN 3
    WHEN 'Thursday' THEN 4
    WHEN 'Friday' THEN 5
    WHEN 'Saturday' THEN 6
    WHEN 'Sunday' THEN 7
  END;

<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <title>AI Avatar Assistants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LiveKit UMD -->
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>

    <style>
      
      .chatbot-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1000;
    }
    .chatbot-bubble {
      background: #f0faff;
      border-radius: 20px;
      padding: 15px;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 1px solid #00ff00;
      margin-bottom: 10px;
      color: black;
    }
    .bubble-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bubble-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .bubble-text p {
      margin: 0;
    }
    .bubble-text p:first-child {
      font-size: 16px;
      font-weight: bold;
    }
    .bubble-text p:last-child {
      font-size: 14px;
    }
    .chat-button {
      background: black;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;
      justify-content: center;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }
    .powered-by {
      font-size: 12px;
      color: gray;
      text-align: center;
      margin-top: 5px;
    }
    .minimize-circle {
      width: 50px;
      height: 50px;
      background: #00cc00;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .minimize-circle svg {
      transition: transform 0.3s;
    }
    .minimize-up svg {
      transform: rotate(180deg);
    }
    .chatbot-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1001;
    }
    .chatbot-popup.active {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .chatbot-container {
      background: #fff;
      width: 80%;
      max-width: 600px;
      height: 80%;
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chatbot-header {
      background: #00cc00;
      padding: 10px 20px;
      color: #fff;
      font-size: 18px;
      font-weight: 600;
    }
    .chatbot-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .chatbot-input {
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    .chatbot-input input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .message.bot {
      background: #e0f7e0;
      text-align: left;
    }
  .message.user {
    background: #d9e6ff;
    text-align: right;
    margin-left: auto;
  }
      :root {
        --topbar-h: 64px; /* header height (matches .with-topbar padding) */
        --composer-h: 88px; /* bottom input bar height allowance */
      }

      /* Base + smooth scrolling */
      html,
      body {
        height: 100%;
        scroll-behavior: smooth;
      }

      /* Theme system: default = light */
      body.theme-light {
        background: #f6f8fa;
        color: #0b0f14;
      }
      body.theme-dark {
        background: #0b0f14;
        color: #ffffff;
      }

      /* Transition theme changes smoothly */
      body {
        transition: background 0.25s ease, color 0.25s ease;
      }

      /* Override common Tailwind utility colors for light theme */
      /* Text whites -> dark equivalents */
      .theme-light .text-white {
        color: #0b0f14;
      }
      .theme-light .text-white\/90 {
        color: rgba(11, 15, 20, 0.9);
      }
      .theme-light .text-white\/80 {
        color: rgba(11, 15, 20, 0.8);
      }
      .theme-light .text-white\/70 {
        color: rgba(11, 15, 20, 0.7);
      }
      .theme-light .text-white\/60 {
        color: rgba(11, 15, 20, 0.6);
      }
      .theme-light .text-white\/50 {
        color: rgba(11, 15, 20, 0.5);
      }
      .theme-light .text-white\/40 {
        color: rgba(11, 15, 20, 0.4);
      }
      .theme-light .text-white\/30 {
        color: rgba(11, 15, 20, 0.3);
      }

      /* Background whites/blacks tuned for light theme */
      .theme-light .bg-white\/5 {
        background-color: rgba(0, 0, 0, 0.04);
      }
      .theme-light .bg-white\/10 {
        background-color: rgba(0, 0, 0, 0.08);
      }
      .theme-light .bg-black\/40 {
        background-color: rgba(0, 0, 0, 0.06);
      }

      /* Border whites tuned for light theme */
      .theme-light .border-white\/10 {
        border-color: rgba(0, 0, 0, 0.08);
      }
      .theme-light .border-white\/20 {
        border-color: rgba(0, 0, 0, 0.15);
      }

      /* Glass effect per theme */
      .glass {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .theme-dark .glass {
        background: rgba(13, 17, 23, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .theme-light .glass {
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }

      /* Custom scrollbar for chat panel */
      .scrollbar-thin::-webkit-scrollbar {
        width: 8px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 8px;
      }
      .theme-dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
      }

      /* Message bubbles */
      .bubble {
        border-radius: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
      }
      /* Assistant bubble in light theme */
      .theme-light .assistant-bubble {
        background: rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      /* Assistant bubble in dark theme */
      .theme-dark .assistant-bubble {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Responsive layout tweaks */
      @media (max-width: 1024px) {
        #chatSplit {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
          height: auto; /* mobile uses explicit panel heights below */
          overflow: visible;
        }
        #chatPanel {
          order: 2;
          height: 42vh;
        }
        #stagePanel {
          order: 1;
          height: 46vh;
        }
      }
      @media (max-width: 640px) {
        #messageInput {
          padding-bottom: 68px; /* Space for the mobile bottom bar */
        }
        :root {
          --composer-h: 96px;
        }
      }

      /* Desktop: bound the split area so the page doesn't grow */
      @media (min-width: 1025px) {
        #chatSplit {
          height: calc(100vh - var(--topbar-h) - var(--composer-h));
          overflow: hidden; /* keep internal scrolls only */
        }
        #stagePanel,
        #chatPanel {
          height: 100%;
        }
      }

      /* Floating connection status dot */
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 9999px;
        display: inline-block;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.12) inset;
      }

      /* Simple toast */
      #toast {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        z-index: 60;
        display: none;
      }

      /* Top navigation polish */
      .icon-btn {
        position: relative;
        border-radius: 0.75rem;
        padding: 0.5rem;
        transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease,
          border-color 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .theme-light .icon-btn {
        border-color: rgba(0, 0, 0, 0.06);
      }
      .icon-btn:hover {
        /* Consistent hover for all header buttons */
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.14);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.16);
      }
      .theme-light .icon-btn:hover {
        background: rgba(0, 0, 0, 0.06);
        border-color: rgba(0, 0, 0, 0.12);
      }
      .icon-btn:active {
        transform: translateY(0px) scale(0.98);
      }
      

      /* Theme button: distinct hover/active */
      #btnTheme:hover {
        box-shadow: 0 6px 18px rgba(16, 185, 129, 0.25);
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.12),
          rgba(59, 130, 246, 0.12)
        );
      }
      #btnTheme:hover .spin-on-hover {
        transform: rotate(28deg);
      }
      .spin-on-hover {
        transition: transform 0.25s ease;
      }

      /* Card polish */
      .card {
        transition: transform 0.22s ease, box-shadow 0.22s ease, border-color 0.22s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .theme-light .card {
        border-color: rgba(0, 0, 0, 0.06);
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      }

      /* Stage overlay polish */
      #stageOverlay .loader {
        height: 40px;
        width: 40px;
        border-radius: 9999px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-top-color: rgba(255, 255, 255, 0.7);
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Spacing to account for fixed top nav */
      .with-topbar {
        padding-top: var(--topbar-h); /* ~ top bar height */
      }
      
    </style>
  </head>
  <body class="min-h-screen text-white theme-light">
    <!-- Global Top Navigation (moved former left buttons here) -->
    <header class="fixed top-0 left-0 right-0 z-50">
      <div
        class="glass px-3 sm:px-5 py-2.5"
        style="border-top-left-radius: 0; border-top-right-radius: 0; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px"
      >
        <div class="max-w-[1400px] mx-auto flex items-center justify-between gap-3">
          <!-- Brand -->
          <div class="flex items-center gap-3 min-w-0">
            <div
              class="h-8 w-8 rounded-xl bg-gradient-to-br from-emerald-500/70 to-cyan-500/70 flex items-center justify-center text-white shadow-sm"
              aria-hidden="true"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M4 7.5h16M4 12h12M4 16.5h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </div>
            <div class="truncate">
              <div class="text-sm sm:text-base font-semibold tracking-tight truncate">
                AI Avatar Assistants
              </div>
              <div class="text-[11px] sm:text-xs text-white/50 truncate">Real‑time, natural, and fast</div>
            </div>
          </div>

          <!-- Chat context controls (only visible during a session) -->
          <div id="chatStatusBar" class="hidden md:flex items-center gap-4 min-w-0">
            <button
              id="backBtn"
              class="icon-btn glass flex items-center gap-2 text-white/90 hover:text-white px-3 py-2"
              title="Back"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span class="hidden sm:inline">Back</span>
            </button>

            <div class="min-w-0">
              <div class="text-xs text-white/80 truncate" id="assistantName">Assistant</div>
              <div class="text-[11px] text-white/50 flex items-center gap-2 min-w-0">
                <span class="status-dot bg-red-500/80" id="connDot"></span>
                <span id="connLabel" class="truncate">Disconnected</span>
              </div>
            </div>

            <div class="text-[11px] text-white/50 truncate" id="miniStatus"></div>
          </div>

          <!-- Utility buttons -->
          <div class="flex items-center gap-2">
            <button id="btnProfile" class="icon-btn" title="Profile">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-white/90">
                <path
                  d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>

            <!-- Settings button -->
            <button id="btnSettings" class="icon-btn" title="Settings">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-white/90">
                <!-- Clean, balanced gear -->
                <path
                  d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M19.4 14.5a7.9 7.9 0 0 0 .1-1.5 7.9 7.9 0 0 0-.1-1.5l2.1-1.6c.2-.15.27-.44.14-.64l-2-3.46a.5.5 0 0 0-.6-.2l-2.5 1a8.6 8.6 0 0 0-1.3-.75l-.4-2.6a.5.5 0 0 0-.5-.4h-4a.5.5 0 0 0-.5.4l-.4 2.6c-.45.2-.89.45-1.3.75l-2.5-1a.5.5 0 0 0-.6.2l-2 3.46c-.13.2-.06.49.14.64L4.6 11.5a7.9 7.9 0 0 0-.1 1.5c0 .5.03 1 .1 1.5L2.5 16.1c-.2.15-.27.43-.14.64l2 3.46c.12.2.37.28.6.2l2.5-1c.41.3.85.55 1.3.75l.4 2.6a.5.5 0 0 0 .5.4h4a.5.5 0 0 0 .5-.4l.4-2.6c.45-.2.89-.45 1.3-.75l2.5 1c.22.08.48 0 .6-.2l2-3.46c.13-.2.06-.49-.14-.64L19.4 14.5Z"
                  stroke="currentColor"
                  stroke-width="1.4"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>

            <button id="btnAbout" class="icon-btn" title="About Us">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-white/90">
                <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z" stroke="currentColor" stroke-width="1.8" />
                <path d="M12 16v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <circle cx="12" cy="8" r="1.5" fill="currentColor" />
              </svg>
            </button>

            <button id="btnTheme" class="icon-btn" title="Toggle Theme">
              <svg id="iconTheme" width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-white/90 spin-on-hover">
                <path
                  d="M12 4V2M12 22v-2M4.93 4.93 3.51 3.51M20.49 20.49l-1.42-1.42M4 12H2m20 0h-2M4.93 19.07l-1.42 1.42M20.49 3.51l-1.42 1.42"
                  stroke="currentColor"
                  stroke-width="1.6"
                  stroke-linecap="round"
                />
                <circle cx="12" cy="12" r="4.5" stroke="currentColor" stroke-width="1.6" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Toast -->
    <div id="toast" class="glass rounded-lg px-3 py-2 text-sm text-white/90"></div>

    <!-- About Modal -->
    <div id="aboutModal" class="fixed inset-0 hidden items-center justify-center z-50" aria-hidden="true">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="relative w-[min(680px,92vw)] glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">About Us</h3>
          <button id="aboutClose" class="text-white/70 hover:text-white/90">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="text-sm text-white/70 leading-relaxed">
          We build modern conversational avatars that feel natural, helpful, and fast. This demo showcases multiple assistants
          powered by real‑time streaming. Our mission is to make human--AI collaboration delightful and accessible to everyone.
          Thanks for trying it out--more avatars and features are on the way!
        </div>
      </div>
    </div>

    <!-- Landing Screen -->
    <main id="landing" class="min-h-screen w-full flex items-center justify-center p-6 with-topbar">
      <div class="max-w-6xl w-full">
        <header class="mb-8 text-center">
          <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight">Choose your AI Avatar Assistant</h1>
          <p class="text-sm text-white/60 mt-2">Pick a persona to start a conversation.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
          <!-- General Assistant Card -->
          <button
            id="openGeneral"
            class="group relative overflow-hidden rounded-2xl p-6 glass card focus:outline-none focus:ring-2 focus:ring-emerald-400/40"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-cyan-500/10 opacity-0 group-hover:opacity-100 transition pointer-events-none"
            ></div>
            <div class="relative">
              <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-emerald-500/30 flex items-center justify-center text-white">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 7.5h16M4 12h12M4 16.5h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <h2 class="text-2xl font-semibold">General Assistant</h2>
              </div>
              <p class="text-white/70 mt-2">Ask about anything. Your everyday AI companion.</p>
            </div>
          </button>

          <!-- School Assistant Card -->
          <button
            id="openSchool"
            class="group relative overflow-hidden rounded-2xl p-6 glass card focus:outline-none focus:ring-2 focus:ring-indigo-400/40"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-fuchsia-500/10 opacity-0 group-hover:opacity-100 transition pointer-events-none"
            ></div>
            <div class="relative">
              <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-indigo-500/30 flex items-center justify-center text-white">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M3 7l9-4 9 4-9 4-9-4Zm2 7.5v-5l7 3 7-3v5" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <h2 class="text-2xl font-semibold">School Assistant</h2>
              </div>
              <p class="text-white/70 mt-2">Homework help, explanations, and study guidance.</p>
            </div>
          </button>

          <!-- Receipt Assistant Card -->
          <button
            id="openReceipt"
            class="group relative overflow-hidden rounded-2xl p-6 glass card focus:outline-none focus:ring-2 focus:ring-amber-400/40"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-amber-500/10 to-rose-500/10 opacity-0 group-hover:opacity-100 transition pointer-events-none"
            ></div>
            <div class="relative">
              <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-amber-500/30 flex items-center justify-center text-white">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M3 6h18v12H3z" stroke="currentColor" stroke-width="2" />
                    <path d="M6 12h6M6 9h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <h2 class="text-2xl font-semibold">Receipt Assistant</h2>
              </div>
              <p class="text-white/70 mt-2">Check processing, verification, and related questions.</p>
            </div>
          </button>

          <!-- Add New Avatar (Coming soon) -->
          <button
            id="openAddNewAvatar"
            class="group relative overflow-hidden rounded-2xl p-6 glass card focus:outline-none focus:ring-2 focus:ring-slate-400/40"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-slate-500/10 to-neutral-500/10 opacity-0 group-hover:opacity-100 transition pointer-events-none"
            ></div>
            <div class="relative">
              <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-slate-500/30 flex items-center justify-center text-white">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <h2 class="text-2xl font-semibold">Add New Avatar</h2>
              </div>
              <p class="text-white/70 mt-2">Create or upload your own avatar (coming soon).</p>
            </div>
          </button>
        </div>
      </div>
      <div class="chatbot-widget" id="chatbot-widget">
    <div class="chatbot-bubble" id="chatbot-bubble">
      <div class="bubble-header">
        <img src="https://i.imgur.com/0x1zQ1f.png" alt="Chatbot Icon" class="bubble-icon">
        <div class="bubble-text">
          <p>Hi there!</p>
          <p>How can I help you?</p>
        </div>
      </div>
      <button id="chat-button" class="chat-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" class="bi bi-whatsapp" viewBox="0 0 16 16">
          <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
        </svg>
        Chat with us >
      </button>
    </div>
    <div class="minimize-circle" id="minimize-circle">
      <svg fill="white" viewBox="0 0 24 24" width="24" height="24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
  </div>

  <!-- Chatbot Popup -->
  <div class="chatbot-popup" id="chatbot-popup">
    <div class="chatbot-container">
      <div class="chatbot-header">Chat with us</div>
      <div class="chatbot-messages" id="chatbot-messages">
        <div class="message bot">Hi there! How can I help you?</div>
      </div>
      <div class="chatbot-input">
        <input type="text" id="chatbot-input" placeholder="Type your message...">
      </div>
    </div>
  </div>
    </main>

    <!-- Fullscreen Chat + Stage -->
    <section id="chatRoot" class="fixed inset-0 hidden with-topbar">
      <!-- Background -->
      <div class="absolute inset-0 bg-gradient-to-b from-[#0b0f14] via-[#0b0f14] to-[#0b0f14] theme-dark:block hidden"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-[#f6f8fa] via-[#f6f8fa] to-[#f6f8fa] theme-light:block hidden"></div>

      <!-- Main Split -->
      <div id="chatSplit" class="relative z-10 grid grid-cols-[1fr_380px] gap-5 px-4 sm:px-6 pb-28">
        <!-- Stage (Avatar Video) -->
        <div id="stagePanel" class="rounded-2xl overflow-hidden glass relative">
          <div
            class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_left,rgba(6,182,212,0.08),transparent_40%),radial-gradient(ellipse_at_bottom_right,rgba(139,92,246,0.08),transparent_40%)] pointer-events-none"
          ></div>

          <video id="avatarVideo" class="w-full h-full object-contain bg-black/40" autoplay playsinline></video>

          <!-- Overlay loader -->
          <div id="stageOverlay" class="absolute inset-0 flex flex-col items-center justify-center gap-3 text-white/80">
            <div class="loader"></div>
            <div class="text-sm">Starting the avatar…</div>
          </div>
        </div>

        <!-- Chat Panel -->
        <aside id="chatPanel" class="rounded-2xl glass flex flex-col overflow-hidden">
          <div class="px-4 pt-4 pb-3 border-b border-white/10 flex items-center justify-between">
            <div>
              <div class="text-sm text-white/60">Conversation</div>
              <div class="text-xs text-white/40">Your messages and assistant replies</div>
            </div>
            <button
              id="clearChat"
              class="text-xs px-3 py-1.5 rounded-md bg-white/5 hover:bg-white/10 transition"
              title="Clear conversation"
            >
              Clear
            </button>
          </div>

          <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin"></div>
        </aside>
      </div>

      <!-- Input Bar -->
      <div class="fixed left-0 right-0 bottom-0 z-20 px-4 sm:px-6 pb-4">
        <div class="max-w-[1400px] mx-auto">
          <div class="glass rounded-2xl p-2 sm:p-3">
            <form id="composer" class="flex items-end gap-2">
              <textarea
                id="messageInput"
                rows="1"
                placeholder="Type your message and press Enter…"
                class="flex-1 bg-transparent outline-none resize-none placeholder-white/40 px-3 py-2"
              ></textarea>
              <button
                id="sendBtn"
                type="submit"
                class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 transition disabled:opacity-50 disabled:cursor-not-allowed text-white"
              >
                Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </section>
    

    <script>
      // ========= Configuration =========
      const API_CONFIG = {
        apiKey: "Yzk2Yzg5ZjkwZjAxNGJkYWIzZjFhMDY0MDdlMDc3YWEtMTc1NDQ3NTM1Nw==",
        serverUrl: "https://api.heygen.com",
      };

      const AVATARS = {
        general: {
          name: "Wayne_20240711",
          openingText: "Hi! I’m your general assistant. How can I help you today?",
          label: "General Assistant",
        },
        school: {
          name: "Graham_Chair_Sitting_public",
          openingText: "Hi! I’m your school assistant. What topic are we studying today?",
          label: "School Assistant",
        },
        receipt: {
          name: "Alessandra_Chair_Sitting_public",
          openingText:
            "Hi! I’m your receipt assistant. I can help with check processing, verification, and related questions. What do you need?",
          label: "Receipt Assistant",
        },
      };

      // ========= State =========
      let currentMode = null; // 'general' | 'school' | 'receipt'
      let sessionToken = null;
      let sessionInfo = null;
      let room = null;
      let mediaStream = null;
      let ws = null;
      let starting = false;
      let toastTimer = null;

      // ========= DOM refs =========
      const landing = document.getElementById("landing");
      const chatRoot = document.getElementById("chatRoot");
      const assistantName = document.getElementById("assistantName");
      const connDot = document.getElementById("connDot");
      const connLabel = document.getElementById("connLabel");
      const miniStatus = document.getElementById("miniStatus");
      const avatarVideo = document.getElementById("avatarVideo");
      const stageOverlay = document.getElementById("stageOverlay");
      const messagesEl = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const toastEl = document.getElementById("toast");
      const aboutModal = document.getElementById("aboutModal");
      const chatStatusBar = document.getElementById("chatStatusBar");

      // Top bar buttons
      const btnProfile = document.getElementById("btnProfile");
      const btnSettings = document.getElementById("btnSettings");
      const btnAbout = document.getElementById("btnAbout");
      const btnTheme = document.getElementById("btnTheme");
      const aboutClose = document.getElementById("aboutClose");
      const backBtn = document.getElementById("backBtn");

      // ========= Utility UI =========
      function setConnState(state) {
        // 'connecting' | 'connected' | 'disconnected'
        if (state === "connected") {
          connDot.style.backgroundColor = "rgba(16,185,129,0.95)"; // green
          connLabel.textContent = "Connected";
        } else if (state === "connecting") {
          connDot.style.backgroundColor = "rgba(250,204,21,0.95)"; // yellow
          connLabel.textContent = "Connecting…";
        } else {
          connDot.style.backgroundColor = "rgba(239,68,68,0.95)"; // red
          connLabel.textContent = "Disconnected";
        }
      }

      function setStageOverlay(visible, text = "Starting the avatar…") {
        stageOverlay.style.display = visible ? "flex" : "none";
        // last child is the text div
        stageOverlay.querySelector("div:last-child").textContent = text;
      }

      function autoExpandTextarea(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      }

      function scrollMessagesToBottom() {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function addMessage(role, text) {
        const wrap = document.createElement("div");
        const isUser = role === "user";
        wrap.className = "flex " + (isUser ? "justify-end" : "justify-start");
        const bubble = document.createElement("div");
        bubble.className =
          "bubble max-w-[85%] px-3 py-2 text-sm " +
          (isUser ? "bg-emerald-500/20 border border-emerald-400/20" : "assistant-bubble");
        bubble.textContent = text;
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        scrollMessagesToBottom();
        return bubble; // for streaming updates
      }

      // Streaming assistant bubble state
      let currentAssistantBubble = null;
      let assistantChunkTimer = null;

      function addAssistantMessage(initial = "", streaming = true) {
        const bubble = addMessage("assistant", initial);
        if (streaming) {
          currentAssistantBubble = bubble;
        }
        return bubble;
      }

      function finalizeAssistantBubbleSoon() {
        if (assistantChunkTimer) clearTimeout(assistantChunkTimer);
        assistantChunkTimer = setTimeout(() => {
          currentAssistantBubble = null;
          assistantChunkTimer = null;
        }, 1200); // consider response done if quiet for 1.2s
      }

      function updateStreamingBubble(bubble, chunk) {
        bubble.textContent += chunk;
        scrollMessagesToBottom();
        finalizeAssistantBubbleSoon();
      }

      function clearMessages() {
        messagesEl.innerHTML = "";
      }

      function showToast(msg, duration = 1800) {
        toastEl.textContent = msg;
        toastEl.style.display = "block";
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.style.display = "none";
        }, duration);
      }

      function openAbout(open) {
        if (open) {
          aboutModal.classList.remove("hidden");
          aboutModal.classList.add("flex");
        } else {
          aboutModal.classList.add("hidden");
          aboutModal.classList.remove("flex");
        }
      }

      function setChatBarVisible(visible) {
        chatStatusBar.classList.toggle("hidden", !visible);
      }

      function toggleTheme() {
        const body = document.body;
        const light = body.classList.contains("theme-light");
        if (light) {
          body.classList.remove("theme-light");
          body.classList.add("theme-dark");
          try {
            localStorage.setItem("theme", "dark");
          } catch {}
        } else {
          body.classList.remove("theme-dark");
          body.classList.add("theme-light");
          try {
            localStorage.setItem("theme", "light");
          } catch {}
        }
      }

      // ========= Persisted theme preference =========
      (function initTheme() {
        try {
          const saved = localStorage.getItem("theme");
          if (saved === "dark") {
            document.body.classList.remove("theme-light");
            document.body.classList.add("theme-dark");
          } else if (saved === "light") {
            document.body.classList.remove("theme-dark");
            document.body.classList.add("theme-light");
          } else {
            // match OS
            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
              document.body.classList.remove("theme-light");
              document.body.classList.add("theme-dark");
            }
          }
        } catch {}
      })();

      // ========= API helpers =========
      async function getSessionToken() {
        const res = await fetch(`${API_CONFIG.serverUrl}/v1/streaming.create_token`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Api-Key": API_CONFIG.apiKey,
          },
        });
        if (!res.ok) throw new Error("Failed to obtain session token");
        const data = await res.json();
        sessionToken = data?.data?.token;
        return sessionToken;
      }

      function buildWSUrl(sessionId, openingText, sttLanguage = "en") {
        const params = new URLSearchParams({
          session_id: sessionId,
          session_token: sessionToken,
          silence_response: "false",
          opening_text: openingText,
          stt_language: sttLanguage,
        });
        const host = new URL(API_CONFIG.serverUrl).hostname;
        return `wss://${host}/v1/ws/streaming.chat?${params.toString()}`;
      }

      async function createNewSession(avatar_name) {
        if (!sessionToken) await getSessionToken();
        const res = await fetch(`${API_CONFIG.serverUrl}/v1/streaming.new`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionToken}`,
          },
          body: JSON.stringify({
            quality: "high",
            avatar_name,
            version: "v2",
            video_encoding: "H264",
          }),
        });
        if (!res.ok) throw new Error("Failed to create session");
        const data = await res.json();
        sessionInfo = data?.data;
        return sessionInfo;
      }

      async function startStreamingSession() {
        const res = await fetch(`${API_CONFIG.serverUrl}/v1/streaming.start`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionToken}`,
          },
          body: JSON.stringify({ session_id: sessionInfo.session_id }),
        });
        if (!res.ok) throw new Error("Failed to start streaming");
      }

      async function sendTaskText(text) {
        if (!sessionInfo?.session_id) return;
        await fetch(`${API_CONFIG.serverUrl}/v1/streaming.task`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionToken}`,
          },
          body: JSON.stringify({
            session_id: sessionInfo.session_id,
            text,
            task_type: "talk",
          }),
        });
      }

      // ========= LiveKit + Media =========
      function setupRoomEvents(room) {
        // Aggregate media tracks into one MediaStream for one <video>
        mediaStream = new MediaStream();

        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
          try {
            if (track.kind === "video" || track.kind === "audio") {
              mediaStream.addTrack(track.mediaStreamTrack);

              const vTracks = mediaStream.getVideoTracks().length;
              const aTracks = mediaStream.getAudioTracks().length;

              if (vTracks > 0 && aTracks > 0) {
                avatarVideo.srcObject = mediaStream;
                const playAttempt = avatarVideo.play();
                if (playAttempt?.catch) {
                  playAttempt.catch(() => {
                    // If autoplay blocks, UI hint
                    miniStatus.textContent = "Tap anywhere to start audio if it’s blocked by the browser.";
                  });
                }
                setStageOverlay(false);
              }
            }
          } catch (e) {
            console.warn("Track subscribe error:", e);
          }
        });

        room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
          if (!mediaStream) return;
          const mediaTrack = track.mediaStreamTrack;
          if (mediaTrack) {
            try {
              mediaStream.removeTrack(mediaTrack);
            } catch {}
          }
        });

        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          setConnState("disconnected");
          setStageOverlay(true, "Avatar disconnected");
        });

        // LiveKit data channel messages (sometimes carry assistant text)
        room.on(LivekitClient.RoomEvent.DataReceived, (payload) => {
          try {
            const text = new TextDecoder().decode(payload);
            const obj = JSON.parse(text);
            handleIncomingAssistantData(obj);
          } catch {
            // fallback: show raw string as a finalized message
            try {
              const rawText =
                typeof payload === "string"
                  ? payload
                  : new TextDecoder().decode(payload);
              if (rawText && rawText.trim()) {
                addAssistantMessage(rawText.trim(), false);
                finalizeAssistantBubbleSoon();
              }
            } catch {}
          }
        });
      }

      // ========= WebSocket handling (assistant text) =========
      function handleIncomingAssistantData(obj) {
        // Heuristic to display assistant text from a variety of event shapes

        // Streaming chunk fields
        const t =
          obj?.delta?.text ??
          obj?.delta ??
          obj?.text ??
          obj?.message ??
          obj?.content ??
          obj?.answer ??
          obj?.response ??
          null;

        if (t && typeof t === "string") {
          if (!currentAssistantBubble) addAssistantMessage("", true);
          updateStreamingBubble(currentAssistantBubble, t);
          return;
        }

        // Full/finalized message fields
        const full =
          obj?.final_text ??
          obj?.display_text ??
          obj?.output ??
          (Array.isArray(obj?.outputs) ? obj?.outputs.join("") : null);

        if (full && typeof full === "string") {
          addAssistantMessage(full, false); // don't keep streaming pointer
          finalizeAssistantBubbleSoon();
        }

        // Optional: explicit end markers (if provided by backend)
        const isEnd =
          obj?.is_final === true ||
          obj?.event === "response.completed" ||
          obj?.type === "answer_end" ||
          obj?.done === true;
        if (isEnd) {
          finalizeAssistantBubbleSoon();
        }
      }

      function connectWebSocket(sessionId, openingText) {
        return new Promise((resolve) => {
          const url = buildWSUrl(sessionId, openingText);
          ws = new WebSocket(url);

          ws.addEventListener("open", () => {
            resolve();
          });

          ws.addEventListener("message", (event) => {
            try {
              const data = JSON.parse(event.data);
              // Attempt to render assistant text
              handleIncomingAssistantData(data);
            } catch {
              // Ignore non-JSON events
            }
          });

          ws.addEventListener("error", (e) => {
            console.warn("WS error:", e);
          });

          ws.addEventListener("close", () => {
            // closed
          });
        });
      }

      // ========= Lifecycle: start/stop assistant =========
      async function startAssistant(mode) {
        if (starting) return;
        starting = true;

        try {
          setConnState("connecting");
          setStageOverlay(true, "Starting the avatar…");
          miniStatus.textContent = "";

          currentMode = mode;
          const cfg = AVATARS[mode];
          assistantName.textContent = cfg.label;

          // Create LiveKit room
          room = new LivekitClient.Room({
            adaptiveStream: true,
            dynacast: true,
            videoCaptureDefaults: {
              resolution: LivekitClient.VideoPresets.h720.resolution,
            },
          });
          setupRoomEvents(room);

          // Create session
          await createNewSession(cfg.name);

          // Prepare connection then connect WS
          await room.prepareConnection(sessionInfo.url, sessionInfo.access_token);
          await connectWebSocket(sessionInfo.session_id, cfg.openingText);

          // Start streaming, then connect to the room
          await startStreamingSession();
          await room.connect(sessionInfo.url, sessionInfo.access_token);

          setConnState("connected");
          miniStatus.textContent = "Avatar is live.";
        } catch (err) {
          console.error(err);
          setConnState("disconnected");
          setStageOverlay(true, "Failed to start. Try again.");
          miniStatus.textContent = "Error starting assistant.";
        } finally {
          starting = false;
        }
      }

      async function stopAssistant() {
        try {
          // Stop remote session
          if (sessionInfo?.session_id && sessionToken) {
            await fetch(`${API_CONFIG.serverUrl}/v1/streaming.stop`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${sessionToken}`,
              },
              body: JSON.stringify({ session_id: sessionInfo.session_id }),
            }).catch(() => {});
          }
        } catch {}
        try {
          if (ws && ws.readyState === WebSocket.OPEN) ws.close();
        } catch {}
        try {
          if (room) room.disconnect();
        } catch {}

        avatarVideo.srcObject = null;
        mediaStream = null;
        sessionInfo = null;
        ws = null;
        room = null;

        setConnState("disconnected");
        setStageOverlay(true, "Avatar stopped");
      }

      // ========= UI wiring =========
      document.getElementById("openGeneral").addEventListener("click", async () => {
        landing.classList.add("hidden");
        chatRoot.classList.remove("hidden");
        setChatBarVisible(true);
        clearMessages();
        addAssistantMessage("Connecting…", false);
        await startAssistant("general");
        currentAssistantBubble = null;
      });

      document.getElementById("openSchool").addEventListener("click", async () => {
        landing.classList.add("hidden");
        chatRoot.classList.remove("hidden");
        setChatBarVisible(true);
        clearMessages();
        addAssistantMessage("Connecting…", false);
        await startAssistant("school");
        currentAssistantBubble = null;
      });

      document.getElementById("openReceipt").addEventListener("click", async () => {
        landing.classList.add("hidden");
        chatRoot.classList.remove("hidden");
        setChatBarVisible(true);
        clearMessages();
        addAssistantMessage("Connecting…", false);
        await startAssistant("receipt");
        currentAssistantBubble = null;
      });

      document.getElementById("openAddNewAvatar").addEventListener("click", () => {
        showToast("Coming soon.");
      });

      backBtn.addEventListener("click", async () => {
        await stopAssistant();
        chatRoot.classList.add("hidden");
        landing.classList.remove("hidden");
        setChatBarVisible(false);
        messageInput.value = "";
        autoExpandTextarea(messageInput);
        miniStatus.textContent = "";
        currentAssistantBubble = null;
        if (assistantChunkTimer) {
          clearTimeout(assistantChunkTimer);
          assistantChunkTimer = null;
        }
      });

      document.getElementById("clearChat").addEventListener("click", () => {
        clearMessages();
        currentAssistantBubble = null;
        if (assistantChunkTimer) {
          clearTimeout(assistantChunkTimer);
          assistantChunkTimer = null;
        }
      });

      // Composer: auto expand and submit
      messageInput.addEventListener("input", () => {
        autoExpandTextarea(messageInput);
      });

      // Enter to send (Shift+Enter for newline)
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      document.getElementById("composer").addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text || !sessionInfo?.session_id) return;
        addMessage("user", text);
        messageInput.value = "";
        autoExpandTextarea(messageInput);

        // Start a fresh assistant bubble for the next response
        currentAssistantBubble = null;
        if (assistantChunkTimer) {
          clearTimeout(assistantChunkTimer);
          assistantChunkTimer = null;
        }

        try {
          await sendTaskText(text);
        } catch (err) {
          console.error(err);
          miniStatus.textContent = "Failed to send message.";
        }
      });

      // Top bar interactions
      btnProfile.addEventListener("click", () => showToast("Profile: coming soon."));
      btnSettings.addEventListener("click", () => showToast("Settings: coming soon."));
      btnAbout.addEventListener("click", () => openAbout(true));
      aboutClose.addEventListener("click", () => openAbout(false));
      aboutModal.addEventListener("click", (e) => {
        if (e.target === aboutModal) openAbout(false);
      });
      btnTheme.addEventListener("click", () => toggleTheme());

      // Initialize textarea height
      autoExpandTextarea(messageInput);

      // Safety: cleanup on unload
      window.addEventListener("beforeunload", () => {
        try {
          if (ws && ws.readyState === WebSocket.OPEN) ws.close();
        } catch {}
        try {
          if (room) room.disconnect();
        } catch {}
      });

    const chatbotBubble = document.getElementById('chatbot-bubble');
    const minimizeCircle = document.getElementById('minimize-circle');
    const chatButton = document.getElementById('chat-button');
    const chatbotPopup = document.getElementById('chatbot-popup');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');

    minimizeCircle.addEventListener('click', () => {
      if (chatbotBubble.style.display !== 'none') {
        chatbotBubble.style.display = 'none';
        minimizeCircle.classList.add('minimize-up');
      } else {
        chatbotBubble.style.display = 'block';
        minimizeCircle.classList.remove('minimize-up');
      }
    });

    chatButton.addEventListener('click', () => {
      chatbotPopup.classList.add('active');
    });

    chatbotPopup.addEventListener('click', (e) => {
      if (e.target === chatbotPopup) {
        chatbotPopup.classList.remove('active');
      }
    });

    chatbotInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && chatbotInput.value.trim()) {
        const userMessage = chatbotInput.value.trim();
        chatbotMessages.innerHTML += `<div class="message user">${userMessage}</div>`;
        chatbotInput.value = '';
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

        // Simulate server response (replace with actual API call)
        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{ role: 'user', content: userMessage }]
          })
        });
        const data = await response.json();
        chatbotMessages.innerHTML += `<div class="message bot">${data.response}</div>`;
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }
      
    });
    </script>
  </body>
</html>